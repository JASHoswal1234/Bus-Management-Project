{% extends "base.html" %}
{% block title %}Track Your Bus{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #user-map { height: 400px; border-radius: 8px; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center"><i class="bi bi-geo-alt"></i> Track Your Bus</h2>

    <div class="card my-4" style="max-width: 600px; margin: 0 auto;">
        <div class="card-body">
            <label class="form-label">Select Route</label>
            <select class="form-select" id="route-select">
                <option value="">Choose a route...</option>
                {% for route in routes %}
                <option value="{{ route.id }}">{{ route.route_name }}</option>
                {% endfor %}
            </select>
            <button class="btn btn-primary mt-3 w-100" onclick="trackBus()">Track Bus</button>
        </div>
    </div>

    <div class="card" id="result-card" style="display: none;">
        <div class="card-header">Bus Location</div>
        <div class="card-body">
            <div id="bus-info"></div>
            <div id="user-map" class="mt-3"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let userMap = null;

    function trackBus() {
        const routeId = document.getElementById('route-select').value;
        if (!routeId) return alert('Please select a route');

        fetch('/dashboard/api/buses/active')
            .then(r => r.json())
            .then(buses => {
                if (buses.length === 0) return alert('No active buses');

                const bus = buses[0];
                document.getElementById('result-card').style.display = 'block';
                document.getElementById('bus-info').innerHTML = `
                    <h5>${bus.bus_number}</h5>
                    <p>Speed: ${bus.speed.toFixed(1)} km/h</p>
                `;

                if (!userMap) {
                    userMap = L.map('user-map').setView([bus.lat, bus.lng], 14);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(userMap);
                }

                L.marker([bus.lat, bus.lng]).addTo(userMap)
                    .bindPopup(`<b>${bus.bus_number}</b>`).openPopup();
            });
    }
</script>
{% endblock %}
